---
layout: post
category : opensource project
tags : [android,cobub razor]
---
razor的服务器端需要完成数据的采集、统计分析、展示的工作。数据采集依赖于提供的api接受client发回的数据，统计分析是依赖于mysql数据库的存储过程来完成的，而数据的展示则是依靠一个php开发的后台实现，里面大量的报表展示和导出，还是非常不错的。

#数据分库
razor有两个database，分别是原始数据和数据的data warehouse，这里我们把两个库的名字分别命名为razor和razordw。
##原始数据
原始数据库的所有表如下,下面会做一些简单的介绍：

    +------------------------+
    | Tables_in_razor        |
    +------------------------+
    | razor_alert            |
    | razor_alertdetail      |
    | razor_cell_towers      |
    | razor_channel          |
    | razor_channel_product  |
    | razor_ci_sessions      |
    | razor_clientdata       |
    | razor_clientusinglog   |
    | razor_config           |
    | razor_errorlog         |
    | razor_event_defination |
    | razor_eventdata        |
    | razor_login_attempts   |
    | razor_markevent        |
    | razor_mccmnc           |
    | razor_networktype      |
    | razor_platform         |
    | razor_product          |
    | razor_product_category |
    | razor_product_version  |
    | razor_productfiles     |
    | razor_reportlayout     |
    | razor_target           |
    | razor_targetevent      |
    | razor_user2role        |
    | razor_user_autologin   |
    | razor_user_permissions |
    | razor_user_profiles    |
    | razor_user_resources   |
    | razor_user_roles       |
    | razor_users            |
    | razor_wifi_towers      |
    +------------------------+
###客户端基本信息表 razor_cliendata
clientdata中保存了用户设备的基本信息，每次在客户端调用了`postClientData()`会发送一条数据库到服务器端并保存到clientdata表。clientdata中包含了用户的基本硬件配置信息、地理位置、设备标识以及时间信息，时间维度是一个重要的信息，需要基于它来判断新增用户、活跃用户等。这里的时间是采用了客户端的时间，这样会带来一个问题，客户端的时间并不一定就是准确的时间，有些用户可能手机刚买来没多久，设置的时间日期并不一定准确，那就导致了数据日期的混乱；但是因为采集到的日志可能来自离线日志数据，如果采用服务器时间也不太合适。这里我作了一个修改，作了一个折中的方案。在数据插入原始数据表的时候，判断时间是否大于我们系统的上线时间，比如“2013-05-01”，如果大于这个时间的就认为是可信的数据，否则可能是客户端设置的时间不准确，就修改为服务器端时间。

###事件信息表 razor_eventdata
eventdata表保存了用户自己定义的事件信息，客户端在每次调用`onEvent()`方法的时候会向服务器发送一次请求。event表中最重要的两个字段就是eventid和label了，eventid用来标识是哪个事件，而label可以用来区分同一事件中的不同行为。目前razor对label还没有做统计展示，但是umeng的产品中已经有了对label的分析，我觉得这个功能还是很需要的。


##数据仓库
数据仓库之中的表包括以下这些:

    mysql> show tables;
    +-------------------------------------+
    | Tables_in_razordw                   |
    +-------------------------------------+
    | razor_dim_activity                  |
    | razor_dim_date                      |
    | razor_dim_devicebrand               |
    | razor_dim_devicelanguage            |
    | razor_dim_deviceos                  |
    | razor_dim_deviceresolution          |
    | razor_dim_devicesupplier            |
    | razor_dim_errortitle                |
    | razor_dim_event                     |
    | razor_dim_location                  |
    | razor_dim_network                   |
    | razor_dim_product                   |
    | razor_dim_segment_launch            |
    | razor_dim_segment_usinglog          |
    | razor_fact_clientdata               |
    | razor_fact_errorlog                 |
    | razor_fact_event                    |
    | razor_fact_launch_daily             |
    | razor_fact_reserveusers_monthly     |
    | razor_fact_reserveusers_weekly      |
    | razor_fact_usinglog                 |
    | razor_fact_usinglog_daily           |
    | razor_hour24                        |
    | razor_log                           |
    | razor_sum_accesslevel               |
    | razor_sum_accesspath                |
    | razor_sum_basic_activeusers         |
    | razor_sum_basic_byhour              |
    | razor_sum_basic_channel             |
    | razor_sum_basic_channel_activeusers |
    | razor_sum_basic_product             |
    | razor_sum_basic_product_version     |
    | razor_sum_usinglog_activity         |
    +-------------------------------------+

从表名上就可以明显看出，dataware中的表分为四大类：dim表、fact表、sum表还有log类表。    
昨天在razor的讨论群里咨询了一下razor的开发人员，才明白这套划分是有依据的，设计原则来源于数据仓库的设计原则[Dimensional Modeling](http://hideto.iteye.com/blog/294603),算是写的还不错的中文blog。里面对fact表和dim表进行了描述：

    1，Fact Table 
    包含业务数据的表，如daily_sales_fact_table(date, product_key, store_key, quantity_sold, dollar_sales_amount) 
    fact table分三种粒度类别：transaction/periodic snapshot/accumulating snapshot 
    2，Dimension Table 
    Dimension table是fact table的entry point，包含了业务对象的文本描述，如 
    product_dimension_table(product_key, product_description, sku_number, brand_description, category_description, department_description,...) 
    Fact table和Dimension table需要join来查询数据，所以又称之为join star schema 
    每个数据集市可能包含多个fact tables，每个fact table可能对应5到15个dimension tables 
然后这里还有一篇stackoverflow的文章[what-is-dim-what-is-fact](http://stackoverflow.com/questions/3189512/what-is-dim-what-is-fact),也不错。还有wiki上对[star schema](http://en.wikipedia.org/wiki/Star_schema)的介绍,简单来讲的话，其实就是一个1..n的表关联。

### dim表
dim表主要是保存类型信息，这里的数据可能是静态的，也有可能是动态的。比如razor_dim_event表保存了用户自己定义的所有event，里面的数据都来自用户定义，是静态的数据；而razor_dim_errortitle表中的数据来自原始数据表中采集到的客户端崩溃日志数据，将其title进行distinct之后保存到dim表中。

### fact表
fact表主要保存与时间维度相关的统计数据，表中的一些数据比如date字段不再保存原始的日期，而是存为了dim表中对应类型的ID。例如razor_fact_clientdata表中的`devicelanguage_sk`、`devicesupplier_sk`等字段都会被替换为对应dim表中的ID。fact表中统计的数据也会分为不同的时间维度，比如`razor_fact_usinglog`和`razor_fact_usinglog_daily`表，后者就是数据在天的维度上做一个汇总，同样的还有`razor_fact_reserveusers_monthly`和`razor_fact_reserveusers_weekly`。这些工作就是由后面将要提到的存储过程来完成。

### sum表
目前还没太理解sum表和fact表区分在何处。从数据上看，sum表中的数据进行了更进一步的处理，而不仅仅是在时间维度上的聚合，比如计算了用户的周活跃度、月活跃度等数据，可以直接用于在razor的后台的报表展示，比如其中的`razor_sum_basic_product`表。

### log表
主要是razor_log这个表，存储过程在运行的过程中，会把操作的每一步记录保存在razor_log表中，便于分析问题的时候使用，例如：

    mysql> select * from razor_log limit 10;
    +----+---------+----------------------------+---------------------+---------------+----------+
    | id | op_type | op_name                    | op_date             | affected_rows | duration |
    +----+---------+----------------------------+---------------------+---------------+----------+
    |  1 | rundim  | razor_dim_location         | 2013-04-28 18:57:46 |             0 |        0 |
    |  2 | rundim  | razor_dim_deviceos         | 2013-04-28 18:57:46 |             0 |        0 |
    |  3 | rundim  | razor_dim_devicelanguage   | 2013-04-28 18:57:46 |             0 |        0 |
    |  4 | rundim  | razor_dim_deviceresolution | 2013-04-28 18:57:46 |             0 |        0 |
    |  5 | rundim  | razor_dim_devicesupplier   | 2013-04-28 18:57:46 |             0 |        0 |
    |  6 | rundim  | razor_dim_product          | 2013-04-28 18:57:46 |             0 |        0 |
    |  7 | rundim  | razor_dim_network          | 2013-04-28 18:57:46 |             0 |        0 |
    |  8 | rundim  | razor_dim_activity         | 2013-04-28 18:57:46 |             0 |        0 |
    |  9 | rundim  | razor_dim_errortitle       | 2013-04-28 18:57:46 |             0 |        0 |
    | 10 | rundim  | razor_dim_event            | 2013-04-28 18:57:46 |             0 |        0 |
    +----+---------+----------------------------+---------------------+---------------+----------+



#存储过程
razor的数据处理是通过存储过程来定时完成的，分为hourly、daily、weekly、monthly4个任务，还有一个laterdata。

##hourly任务
hourly任务每小时执行一次，主要是用来将原始数据导入数据仓库中。


未完待续....
