---
layout: post
category : opensource project
tags : [android,cobub razor]
---
razor的服务器端需要完成数据的采集、统计分析、展示的工作。数据采集依赖于提供的api接受client发回的数据，统计分析是依赖于mysql数据库的存储过程来完成的，而数据的展示则是依靠一个php开发的后台实现，里面大量的报表展示和导出，还是非常不错的。

#数据分库
razor有两个database，分别是原始数据和数据的data warehouse，这里我们把两个库的名字分别命名为razor和razordw。
##原始数据
原始数据库的所有表如下,下面会做一些简单的介绍：
    +------------------------+
    | Tables_in_razor        |
    +------------------------+
    | razor_alert            |
    | razor_alertdetail      |
    | razor_cell_towers      |
    | razor_channel          |
    | razor_channel_product  |
    | razor_ci_sessions      |
    | razor_clientdata       |
    | razor_clientusinglog   |
    | razor_config           |
    | razor_errorlog         |
    | razor_event_defination |
    | razor_eventdata        |
    | razor_login_attempts   |
    | razor_markevent        |
    | razor_mccmnc           |
    | razor_networktype      |
    | razor_platform         |
    | razor_product          |
    | razor_product_category |
    | razor_product_version  |
    | razor_productfiles     |
    | razor_reportlayout     |
    | razor_target           |
    | razor_targetevent      |
    | razor_user2role        |
    | razor_user_autologin   |
    | razor_user_permissions |
    | razor_user_profiles    |
    | razor_user_resources   |
    | razor_user_roles       |
    | razor_users            |
    | razor_wifi_towers      |
    +------------------------+


###客户端基本信息表 razor_cliendata
clientdata中保存了用户设备的基本信息，每次在客户端调用了`postClientData()`会发送一条数据库到服务器端并保存到clientdata表。clientdata中包含了用户的基本硬件配置信息、地理位置、设备标识以及时间信息，时间维度是一个重要的信息，需要基于它来判断新增用户、活跃用户等。这里的时间是采用了客户端的时间，这样会带来一个问题，客户端的时间并不一定就是准确的时间，有些用户可能手机刚买来没多久，设置的时间日期并不一定准确，那就导致了数据日期的混乱；但是因为采集到的日志可能来自离线日志数据，如果采用服务器时间也不太合适。这里我作了一个修改，作了一个折中的方案。在数据插入原始数据表的时候，判断时间是否大于我们系统的上线时间，比如“2013-05-01”，如果大于这个时间的就认为是可信的数据，否则可能是客户端设置的时间不准确，就修改为服务器端时间。

###事件信息表 razor_eventdata
eventdata表保存了用户自己定义的事件信息，客户端在每次调用`onEvent()`方法的时候会向服务器发送一次请求。event表中最重要的两个字段就是eventid和label了，eventid用来标识是哪个事件，而label可以用来区分同一事件中的不同行为。目前razor对label还没有做统计展示，但是umeng的产品中已经有了对label的分析，我觉得这个功能还是很需要的。


##数据仓库
数据仓库之中的表包括以下这些:
    +-------------------------------------+
    | Tables_in_razordw                   |
    +-------------------------------------+
    | razor_dim_activity                  |
    | razor_dim_date                      |
    | razor_dim_devicebrand               |
    | razor_dim_devicelanguage            |
    | razor_dim_deviceos                  |
    | razor_dim_deviceresolution          |
    | razor_dim_devicesupplier            |
    | razor_dim_errortitle                |
    | razor_dim_event                     |
    | razor_dim_location                  |
    | razor_dim_network                   |
    | razor_dim_product                   |
    | razor_dim_segment_launch            |
    | razor_dim_segment_usinglog          |
    | razor_fact_clientdata               |
    | razor_fact_errorlog                 |
    | razor_fact_event                    |
    | razor_fact_launch_daily             |
    | razor_fact_reserveusers_monthly     |
    | razor_fact_reserveusers_weekly      |
    | razor_fact_usinglog                 |
    | razor_fact_usinglog_daily           |
    | razor_hour24                        |
    | razor_log                           |
    | razor_sum_accesslevel               |
    | razor_sum_accesspath                |
    | razor_sum_basic_activeusers         |
    | razor_sum_basic_byhour              |
    | razor_sum_basic_channel             |
    | razor_sum_basic_channel_activeusers |
    | razor_sum_basic_product             |
    | razor_sum_basic_product_version     |
    | razor_sum_usinglog_activity         |
    +-------------------------------------+
从表名上就可以明显看出，dataware中的表分为四大类：dim表、fact表、sum表还有log类表。


#存储过程
razor的数据处理是通过存储过程来定时完成的，分为hourly、daily、weekly、monthly4个任务，还有一个laterdata。

##hourly任务
hourly任务每小时执行一次，主要是用来将原始数据导入数据仓库中。


未完待续....
